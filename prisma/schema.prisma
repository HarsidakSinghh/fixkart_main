// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// ==========================================
// 1. PRODUCT & INVENTORY
// ==========================================

model Product {
  id             String   @id @default(auto()) @map("_id") @db.ObjectId
  
  // --- OWNER TRACKING ---
  vendorId       String   // Clerk User ID of the Seller
  
  // --- IDENTIFICATION ---
  name           String   
  title          String?  
  slug           String   @unique
  description    String?  
  status         String   @default("PENDING") 

  // --- HIERARCHY ---
  category       String 
  subCategory    String? 
  subSubCategory String? 

  // --- IMAGES ---
  image          String 
  imagePath      String? 
  gallery        String[] 
  
  // --- PRICE & INVENTORY ---
  price          Float    @default(0.0)
  quantity       Int      @default(10)
  sku            String?  @unique
  
  // --- SPECS ---
  specs          Json?    
  brand          String?
  
  // --- STATUS ---
  isPublished    Boolean  @default(true)
  isFeatured     Boolean  @default(false)

  // --- RELATIONS ---
  variants       Variant[]
  orderItems     OrderItem[] 

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model Variant {
  id        String  @id @default(auto()) @map("_id") @db.ObjectId
  name      String 
  price     Float
  stock     Int     @default(0)
  sku       String?
  
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId String  @db.ObjectId
}

// ==========================================
// 2. VENDOR PROFILE
// ==========================================

model VendorProfile {
  id             String   @id @default(auto()) @map("_id") @db.ObjectId
  userId         String   @unique // Clerk User ID

  status         String   @default("PENDING")

  // --- BASIC INFO ---
  fullName       String
  companyName    String?
  gstNumber      String?
  phone          String
  email          String
  address        String
  city           String
  state          String
  postalCode     String

  // --- BUSINESS DETAILS ---
  category        String? 
  businessType    String? 
  yearsInBusiness String?
  
  // -- DOCS --
  gstCertificateUrl  String?
  msmeCertificateUrl String?
  panCardUrl         String?
  ownerPhotoUrl      String?
  aadharCardUrl      String?

  // --- KYC ---
  idProofType    String 
  idProofNumber  String
  idProofUrl     String 

  // --- BANKING ---
  bankName           String
  accountHolder      String
  accountNumber      String
  ifscCode           String
  cancelledChequeUrl String?

  // --- EXTRA ---
  tradeLicense       String?
  contactPerson      String?
  alternateContact   String?
  
  // --- BACKUP CONTACTS ---
  backup1Name        String?
  backup1Phone       String?
  backup1IdUrl       String?

  backup2Name        String?
  backup2Phone       String?
  backup2IdUrl       String?
  
  // --- LOCATION ---
  gpsLat             Float?
  gpsLng             Float?
  locationPhotoUrl   String

  // --- RELATIONS ---
  orderItems     OrderItem[] // Tracks items sold by this vendor

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

// ==========================================
// 3. CUSTOMER PROFILE (B2B)
// ==========================================

model CustomerProfile {
  id             String   @id @default(auto()) @map("_id") @db.ObjectId
  userId         String   @unique // Clerk User ID
  
  // --- BASIC INFO ---
  fullName       String
  companyName    String
  phone          String
  email          String
  address        String
  city           String
  state          String
  postalCode     String

  // --- BUSINESS DETAILS ---
  category        String?  
  businessType    String?  
  yearsInBusiness String?
  gstNumber       String?
  tradeLicense    String?
  panNumber       String?

  // --- DOCS ---
  businessProofUrl   String?
  idProofUrl         String?
  gstCertificateUrl  String?
  msmeCertificateUrl String?
  panCardUrl         String?
  aadharCardUrl      String?
  ownerPhotoUrl      String?

  // --- BANKING ---
  bankName           String?
  accountHolder      String?
  accountNumber      String?
  ifscCode           String?
  cancelledChequeUrl String?

  // --- BACKUP CONTACTS ---
  backup1Name        String?
  backup1Phone       String?
  backup1IdUrl       String?

  backup2Name        String?
  backup2Phone       String?
  backup2IdUrl       String?

  // --- LOCATION ---
  gpsLat             Float?
  gpsLng             Float?
  locationPhotoUrl   String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  status          String   @default("PENDING")
}

// ==========================================
// 4. ORDER MANAGEMENT
// ==========================================

model Order {
  id            String      @id @default(cuid()) @map("_id")
  customerId    String      // Clerk User ID of customer
  customerName  String?     
  customerEmail String?     
  customerPhone String?     

  address       String
  
  totalAmount   Float
  status        String      @default("PENDING") 
  
  items         OrderItem[] 
  
  // Relation to Complaints
  complaints    Complaint[]

  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  invoiceUrl     String?     // URL to generated PDF invoice
  customerPoUrl  String?     // [NEW] URL to generated Customer PO (Customer -> Fixkart)
}

model OrderItem {
  id            String   @id @default(cuid()) @map("_id")
  
  // Link to Order
  orderId       String
  order         Order    @relation(fields: [orderId], references: [id])
  
  // Link to Product
  productId     String   @db.ObjectId
  product       Product  @relation(fields: [productId], references: [id])
  
  // Link to Vendor
  vendorId      String   
  vendor        VendorProfile @relation(fields: [vendorId], references: [userId])

  quantity      Int
  price         Float    
  status        String   @default("PENDING") 

  // --- DELIVERY & DOCS ---
  deliveryDate      DateTime?
  transportSlipUrl  String[]   // <--- CHANGED from String? to String[]
  billUrl           String[]   // <--- CHANGED from String? to String[]

  // Relation to Refund
  refundRequest     RefundRequest?

  createdAt     DateTime @default(now())
}

// ==========================================
// 5. RETURNS & COMPLAINTS
// ==========================================

model RefundRequest {
  id          String    @id @default(cuid()) @map("_id")
  
  // Link to Item
  orderItemId String    @unique
  item        OrderItem @relation(fields: [orderItemId], references: [id])

  vendorId    String
  customerId  String
  reason      String
  status      String    @default("PENDING") 
  proofImages String[] // <--- ADD THIS
  createdAt   DateTime  @default(now())
}

model Complaint {
  id          String   @id @default(cuid()) @map("_id")
  
  // Link to Order
  orderId     String
  order       Order    @relation(fields: [orderId], references: [id])

  vendorId    String?  // Made optional in case it's a general order complaint
  customerId  String
  message     String
  status      String   @default("OPEN") 
  proofImages String[] // <--- ADD THIS
  vendorSolution     String?    // The solution description provided by vendor
  closureRequestedAt DateTime?

  createdAt   DateTime @default(now())
}

model ProductTypeImageCache {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  key       String   @unique
  imageUrl  String
  source    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
